
%% Hardcoded data from a graph fit. this defines a function used in the engine model
% used only for reference, not ever called within the code

%% psi vs phi
clc; clear; close all;


data = [0.5964637094507226, 0.3852040816326531
0.983379247015611, 0.4166666666666667
1.1949757313393676, 0.17261904761904762
1.2604580124060645, 0.028911564625850317
1.130430464196698, 0.2789115646258504
1.0525870954442382, 0.3681972789115646
0.8589962706845824, 0.44727891156462585
0.7840613931523023, 0.44642857142857145
0.7002436236202471, 0.43027210884353745
0.6472686044114615, 0.41156462585034015
0.9184591743033301, 0.4379251700680272
1.0942617267292594, 0.3231292517006802
1.1588931991529394, 0.23639455782312896
1.1752946908791073, 0.20748299319727892
1.2222503326399434, 0.11054421768707484
1.2429770806394194, 0.06292517006802723
1.2691797380109069, 0.007653061224490054];
 
phi = data(:,1);

psi = data(:,2)*1.2/0.5;

p = polyfit(phi,psi,4);


phifit = linspace(0.6,1.26,1e6);
psifit = polyval(p,phifit);

figure(1)

plot(phifit,psifit)
hold on

axis([0.5 1.3 0 1.2])
set(gca, 'Color', 'None');
%%  eta vs zeta/psi

clear; clc; close all

data = [0.2329300951149691, 0.24615384615384617
0.2607442977190878, 0.3999999999999999
0.31439652784190597, 0.6051282051282052
0.28432542247668313, 0.5046153846153842
0.3681854280173611, 0.7343589743589725
0.4500729522578262, 0.8594871794871795
0.6098106935081724, 0.9517948717948719
0.7869461630806169, 0.9825641025641021
0.9403564502724167, 0.9887179487179485
1.1132403730723062, 0.9805128205128204
1.268859543817527, 0.9599999999999995
1.4050383230215162, 0.9353846153846153
1.5347345091882902, 0.9107692307692301
1.612562563486933, 0.8902564102564097
1.7509206759626925, 0.8553846153846147
1.9973995752147011, 0.7774358974358968
2.1920029550281646, 0.7076923076923065];



zeta = data(:,1);

eta = data(:,2);

p = polyfit(zeta,eta,10);


zetafit = linspace(min(zeta),max(zeta),1e6);
etafit = polyval(p,zetafit);

figure(1)

plot(zetafit,etafit)
hold on
%scatter(zeta,eta)

axis([0 1.8 0 1.2])
set(gca, 'Color', 'None');

%% Surge choke ranges for different rpm percentages

clear; clc; close all;

% choke
chokedata = [45.08344030808726, 41.372549019607874
50.20539152759943, 47.84313725490196
57.676508344030715, 56.666666666666686
64.68549422336315, 64.50980392156865
71.7329910141205, 72.35294117647061
78.2413350449292, 79.50980392156865
84.32605905006396, 86.17647058823533
91.48908857509599, 93.72549019607847
97.80487804878018, 100.00000000000003
103.92811296533984, 105.88235294117649
53.97946084723998, 52.25490196078432
68.3055198973041, 68.5294117647059
74.85237483953769, 75.88235294117649
87.83055198973017, 90.00000000000003];

Nc = chokedata(:,1);
Mc = chokedata(:,2);

pc = polyfit(Nc,Mc,5);


Ncfit = linspace(min(Nc),max(Nc),1e6);
Mcfit = polyval(pc,Ncfit);

figure(1)

plot(Ncfit,Mcfit)
hold on
%scatter(zeta,eta)

axis([40 110 0 120])
set(gca, 'Color', 'None');

% surge
surgedata = [47.54813863928109, 13.627450980392155
52.47753530166874, 18.82352941176471
58.90885750962763, 26.274509803921546
63.68421052631567, 32.54901960784311
67.68934531450563, 38.235294117647044
72.34916559691897, 45.3921568627451
76.66238767650816, 51.76470588235293
81.5917843388958, 59.31372549019609
85.90500641848499, 66.56862745098042
89.60205391527575, 73.1372549019608
93.4146341463412, 80.29411764705884
96.30295250320896, 86.27450980392159
99.42233632862613, 92.74509803921572
102.11810012836938, 99.60784313725495
104.04364569961456, 106.07843137254906];

Ns = surgedata(:,1);
Ms = surgedata(:,2);

ps = polyfit(Ns,Ms,5);


Nsfit = linspace(min(Ns),max(Ns),1e6);
Msfit = polyval(ps,Nsfit);


hold on
plot(Nsfit,Msfit)
%scatter(zeta,eta)



%%
function [SurgeLimit, ChokeLimit] = MassFlowLimits(Nrot)
% see EngineModelPkg.MapPkg.MapCreationData
% Nrot is normalized rotation divided by reference normalized rotation, in
% percentage [0 100] NOT [0 1]
% outputs are of the same form
PolyChoke = [0.0000   -0.0000    0.0025   -0.1949    8.6414 -123.0418];
PolySurge = [0.0000   -0.0001    0.0102   -0.6595   21.5792 -283.6719];

ChokeLimit = polyval(PolyChoke,Nrot);
SurgeLimit = polyval(PolySurge,Nrot);

if Nrot < 45
    warning('ENGINE OFF DESIGN: Engine is sub-idle, results may be inaccurate. See +EngineModelPkg/+MapPkg/CreateMap.')
elseif Nrot > 100
    warning('ENGINE OFF DESIGN: Engine is near maximum operating speed and may choke or surge at these conditions. See +EngineModelPkg/+MapPkg/CreateMap.')
end

end % MassFlowLimits


function [NormEta] = ComputeStageEfficiency(NormZeta, NormPsi)
% compute stage efficiency from historical data found in Gas Turbine
% Performance
PolyEta = [-2.12338832464433	25.3005919077769	-131.743148675269	394.612930768011	-753.573436233432	961.518066538622	-835.517009758314	493.865396155764	-193.640895165930	46.7608691292087	-4.47289630361227];
NormEta = polyval(PolyEta, NormZeta/NormPsi); 
end % ComputeStageEfficiency










